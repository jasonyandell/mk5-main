# ADR-20251111: URL Replay System with Complete GameConfig

**Status**: Accepted
**Date**: 2025-01-11
**Relates to**: ADR-20251110-single-composition-point.md

## Context

The original URL replay system had critical limitations:

1. **Incomplete Config Capture**: URLs only stored `seed`, `actions`, `playerTypes`, `dealer`, and theme. They did NOT capture `actionTransformers` or `enabledRuleSets`, making it impossible to replay games with special contracts (nello, plunge, splash) or action transformers (tournament mode, oneHand, speed).

2. **Architecture Violation**: `urlReplay.ts` imported `createExecutionContext` and `getNextStates` directly, bypassing the single composition point invariant. It created its own execution context with hardcoded config instead of using Room/HeadlessRoom.

3. **Impedance Mismatch**: URLs stored action IDs (compressed strings like "C" = "bid-30"), but HeadlessRoom.replayActions() expected structured GameAction objects. urlReplay manually called `getNextStates()` to match IDs, duplicating composition logic.

## Decision

We redesigned the URL replay system to:

### 1. Extend URL Encoding to Capture Full GameConfig

**Short-code registries** for compact encoding:

```typescript
// Action Transformers
TRANSFORMER_CODES = {
  'one-hand': 'o',
  'speed': 's',
  'hints': 'h'
}

// RuleSets
RULESET_CODES = {
  'nello': 'n',
  'plunge': 'p',
  'splash': 's',
  'sevens': 'v',
  'tournament': 't'
}
```

**New URL format** (actions moved to END for aesthetics):
```
?s={seed}&p={players}&d={dealer}&t={theme}&v={colors}&h={scenario}&at={transformers}&rs={rulesets}&a={actions}
```

**Example**:
```
?s=abc&p=haaa&at=t&rs=n,p&a=CAAS
```
Decodes to: seed=12345, tournament mode, nello + plunge rulesets, actions=['C','A','A','S']

### 2. Create Pure Translation Function

New `src/game/core/action-resolution.ts` provides `resolveActionIds()`:

```typescript
function resolveActionIds(
  actionIds: string[],
  config: GameConfig,
  seed: number
): GameAction[]
```

**Implementation**:
- Creates temporary HeadlessRoom with full config (includes composition)
- For each action ID, gets valid actions at current state
- Matches ID using existing `actionToId()` logic
- Executes matched action to progress state
- Returns array of resolved GameActions

**Key**: This uses HeadlessRoom internally, so composition happens through proper channels. From caller perspective it's a pure utility function.

### 3. Migrate urlReplay to Use HeadlessRoom + Translation Function

**Old approach** (VIOLATED invariant):
```typescript
// ❌ Direct composition
const ctx = createExecutionContext({ playerTypes: ['human'...] });
const transitions = getNextStates(state, ctx);
```

**New approach** (COMPLIANT):
```typescript
// ✅ Use pure translation + HeadlessRoom
const actions = resolveActionIds(actionIds, config, seed);
const room = new HeadlessRoom(config, seed);
room.replayActions(actions);
```

### 4. Verified gameSimulator Compliance

Reviewed `src/game/ai/gameSimulator.ts` - already compliant! It uses HeadlessRoom correctly and does not import `createExecutionContext` or `getNextStates`. No changes needed.

### 5. Updated Architecture Tests

Modified `src/tests/architecture/composition.test.ts`:
- **Removed** "deprecated files" warning test
- **Added** strict enforcement: utils/ and ai/ modules MUST NOT import `createExecutionContext` or `getNextStates`
- Test now FAILS if violations found (not just warns)

## Consequences

### Positive

1. **Complete Replay**: URLs now capture full GameConfig. Tournament mode, nello, plunge, splash games can be shared and replayed deterministically.

2. **Single Composition Point Enforced**: urlReplay uses HeadlessRoom exclusively. No more direct context creation. Architecture tests enforce this strictly.

3. **Correct By Construction**: Pure translation function isolates ID→GameAction complexity. All composition happens through Room/HeadlessRoom.

4. **Compact URLs**: Short-code registries keep URLs reasonably sized. Example: `at=t,o` = tournament + oneHand.

5. **Zero Compatibility Code**: Per requirement, no versioning. All URLs generated by new system. Big-bang migration, roll-forward.

### Negative

1. **Existing URLs Invalid**: Old URLs missing `at`/`rs` params will replay with base rules only. Acceptable trade-off for greenfield project.

2. **Two-Pass Replay**: Translation function creates temporary HeadlessRoom to match IDs, then caller creates another HeadlessRoom to replay. Could optimize later by adding `replayFromIds()` API to HeadlessRoom, but current approach is cleaner separation.

3. **Short Code Registry Maintenance**: Adding new transformers/rulesets requires updating `TRANSFORMER_CODES`/`RULESET_CODES` maps. But these change rarely.

## Implementation Notes

### Files Modified

- `src/game/core/url-compression.ts`: Added short-code registries, extended encode/decode functions
- `src/game/core/action-resolution.ts`: New file, pure translation function
- `src/game/utils/urlReplay.ts`: Complete rewrite using HeadlessRoom + action-resolution
- `src/tests/architecture/composition.test.ts`: Strict enforcement of composition invariant
- `docs/adrs/ADR-20251110-single-composition-point.md`: Updated status (urlReplay migration complete)

### Files NOT Modified (Already Compliant)

- `src/game/ai/gameSimulator.ts`: Already uses HeadlessRoom correctly
- `scripts/replay-from-url.js`: No changes needed, works with new ReplayResult type
- `scripts/get-state-from-url.js`: No changes needed

### Type Safety

Used TypeScript's `exactOptionalPropertyTypes: true` correctly:
- Don't explicitly set optional properties to `undefined`
- Only add optional properties to objects if they have values
- Use conditional assignment pattern

## Examples

### Basic replay with nello
```
?s=abc&rs=n&a=PQRS
```
- seed=abc (base36)
- enabledRuleSets=['nello']
- actions=['P','Q','R','S'] (bid-1-marks, bid-2-marks, bid-3-marks, trump-blanks)

### Tournament mode with multiple rulesets
```
?s=xc9&at=t&rs=n,p,s&a=CAAAMNO
```
- seed=12345
- tournament mode (filters special bids)
- nello + plunge + splash enabled
- actions=['C','A','A','A','M','N','O']

### Full config URL
```
?s=xc9&p=hhaa&d=0&t=dark&at=t,o&rs=n&a=C
```
- seed=12345
- 2 humans, 2 AI
- dealer=0
- dark theme
- tournament + oneHand transformers
- nello ruleset
- actions=['C']

## Validation

1. **Typecheck passes**: `npm run typecheck` → zero errors
2. **Architecture tests pass**: `src/tests/architecture/composition.test.ts` → no violations
3. **Scripts work**: `scripts/replay-from-url.js` and `scripts/get-state-from-url.js` function correctly
4. **Round-trip test**: Encode game → decode → replay → state matches original

## Future Work

1. **URL Versioning**: If we need to support old URLs, add version parameter (not needed for greenfield)
2. **Optimize replay**: Add `HeadlessRoom.replayFromIds(ids[])` API to avoid two-pass replay
3. **Explainer tooling**: Tool to decode URL and show effective config/rules composition
4. **Snapshot compression**: For very long games, consider snapshotting + delta encoding

## Related

- ADR-20251110-single-composition-point.md: Defines composition invariant this ADR enforces
- docs/VISION.md: "Shareable, teachable games" north star outcome
- docs/ORIENTATION.md: Architecture overview and replay flow
